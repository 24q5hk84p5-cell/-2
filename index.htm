<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title id="pageTitle">×‘× ×§ ×”×›×™×ª×” ×—/2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --success: #22c55e; --danger: #ef4444; --text: #f8fafc;
            --gold: #fbbf24; --silver: #94a3b8; --bronze: #d97706;
            --purple: #a855f7;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; direction: rtl; }
        .sticky-header { position: sticky; top: 0; width: 100%; background: rgba(15, 23, 42, 0.95); padding: 15px 0; display: flex; flex-direction: column; align-items: center; z-index: 1000; border-bottom: 2px solid var(--accent); backdrop-filter: blur(10px); }
        .main-title { font-size: 1.8em; font-weight: 800; color: var(--accent); margin: 0; }
        .slogan { font-size: 0.9em; color: #94a3b8; margin-top: 5px; text-align: center; }
        
        .container { width: 95%; max-width: 850px; background: var(--card-bg); border-radius: 24px; overflow: hidden; border: 1px solid #334155; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        
        /* ×¢×™×¦×•×‘ ×¨×©×™××” ××©×•×œ×‘×ª */
        .student-row { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 15px; transition: 0.3s; }
        .student-header { display: flex; align-items: center; gap: 12px; }
        .student-info { flex-grow: 1; display: flex; flex-direction: column; cursor: pointer; }
        .student-name { font-weight: bold; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        
        /* ×‘××“×’'×™× ×©×œ ×¤×¨×¡×™× */
        .prize-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 12px; font-weight: bold; color: white; display: inline-flex; align-items: center; gap: 3px; }
        .badge-nachat { background: var(--purple); box-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }
        .badge-choopar { background: var(--success); box-shadow: 0 0 10px rgba(34, 197, 94, 0.4); }

        .score-box { width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--accent); display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; background: rgba(56, 189, 248, 0.05); }
        .weekly-label { font-size: 0.6em; color: var(--accent); margin-top: -2px; }

        .btn-m { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; }
        .history-panel { display: none; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); font-size: 0.9em; }
        
        /* ×¤×× ×œ × ×™×”×•×œ */
        .admin-panel { display: none; padding: 25px; border-top: 2px solid var(--accent); }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .admin-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; border: 1px solid #334155; }
        input, textarea { background: #0f172a; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        .class-img { width: 95%; max-width: 850px; border-radius: 20px; margin-top: 20px; display: none; border: 2px solid var(--accent); }
        #podium { display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin: 25px 0; height: 120px; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div class="main-title" id="displayTitle">×‘× ×§ ×”×›×™×ª×” ×—/2</div>
        <div class="slogan" id="displaySlogan">"××œ ×ª×”×™×• ×›×¢×‘×“×™×..."</div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
             <button class="tab-btn" style="background:var(--accent); color:var(--bg); border:none; padding:8px 15px; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="toggleAdmin()">âš™ï¸ × ×™×”×•×œ ×•×”×’×“×¨×•×ª</button>
             <button class="tab-btn" style="background:var(--purple); color:white; border:none; padding:8px 15px; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="window.print()">ğŸ–¨ï¸ ×”×“×¤×¡×ª ×–×›××™×</button>
        </div>
    </div>

    <img id="classPhoto" class="class-img">
    <div id="podium"></div>

    <div class="container">
        <div id="studentList"></div>

        <div id="adminPanel" class="admin-panel">
            <div class="admin-grid">
                <div class="admin-card">
                    <h3 style="color:var(--purple); margin-top:0;">ğŸ ×¡×£ ×¤×¨×¡×™×</h3>
                    <label>× ×—×ª (×œ×œ× ×”×¤×¨×¢×•×ª):</label>
                    <input type="number" id="minNachat" onchange="state.prizes.nachat=this.value;save();render();">
                    <label style="margin-top:10px; display:block;">×¦'×•×¤×¨ ×©×‘×•×¢×™:</label>
                    <input type="number" id="minChoopar" onchange="state.prizes.choopar=this.value;save();render();">
                </div>
                <div class="admin-card">
                    <h3 style="color:var(--accent); margin-top:0;">ğŸ“ ×”×¢×œ××ª × ×ª×•× ×™×</h3>
                    <input type="file" id="fileIn" accept=".xlsx, .xls" onchange="loadExcel(event)">
                    <p style="font-size:0.7em; color:#94a3b8;">×”×¢×œ×” ××§×¡×œ ×¢× ××™×œ×•×ª ××¤×ª×—: "×—×™×¡×•×¨", "××™×œ×” ×˜×•×‘×”", "×”×¤×¨×¢×”" (15-).</p>
                </div>
            </div>
            <div class="admin-card" style="margin-bottom:15px;">
                <h3>ğŸ“ ×¢×¨×™×›×ª ×›×™×ª×”</h3>
                <input type="text" id="inputTitle" oninput="updateTexts()" placeholder="×©× ×”×›×™×ª×”"><br><br>
                <input type="file" accept="image/*" onchange="uploadPhoto(event)">
            </div>
            <button class="btn-m" style="background:var(--danger); width:100%; height:45px;" onclick="resetWeek()">ğŸ”„ ××™×¤×•×¡ ×©×‘×•×¢×™ (××•×—×§ × ×™×§×•×“ ×•×”×™×¡×˜×•×¨×™×”)</button>
        </div>
    </div>

<script>
    let state = JSON.parse(localStorage.getItem('class_bank_v21')) || {
        data: [], photo: "", title: "×‘× ×§ ×”×›×™×ª×” ×—/2", slogan: '"××œ ×ª×”×™×• ×›×¢×‘×“×™× ×”××©××©×™× ××ª ×”×¨×‘..."',
        prizes: { nachat: 25, choopar: 45 }
    };

    if (state.data.length === 0) {
        const names = ["××‘×¨××•×‘×™×¥ ×“× ×™××œ", "××™×•×‘ ××™×ª×Ÿ", "××œ×’×¨×‘×œ×™ ×‘× ×™×” ×¢×•×–", "××œ××• × ×ª× ××œ", "××¨×‘×œ ××œ×™×” ××”×¨×•×Ÿ", "×‘×œ×•×¡×˜×•×¦×§×™ ×”×œ×œ ×™×©×™", "×‘×Ÿ ×¢×˜×¨ × ×ª××™ ×™×•×¡×£", "×‘×Ÿ ×¤×•×¨×ª × ×¢×", "×’×•×¨×“×•×Ÿ ×‘× ×™×”", "×’×œ×™×™×–×¨ ×©×œ×•×", "×“×”×Ÿ ×™×•×¡×£ ×—×™×™×", "×”×™×¨×©× ×‘×¨×’×¨ ×‘×•×¢×–", "×•×•×™×¡××Ÿ ×™×”×•× ×ª×Ÿ", "×•×œ×¨ × ×•×•×” ××”×¨×Ÿ", "×˜×× ×” ××‘×™×”×•", "×™×•×©×¢×™ × ×¢×", "×™×¢×§×‘×™ ×™×”×•×“×”", "×›×”×Ÿ ×œ×™××•×¨", "×›×”×Ÿ × ×™×ª××™", "×× ×¦×•×¨ ×”×¨××œ", "××¨×¡×™×× ×• ××•×¨×™", "× ×“×œ × ×•×”", "× ×™××–×•×‘ ××‘×™××œ", "×¡×× ×™ ×©×‘×—", "×¤×•×¨×¡×˜ ×¢××™×—×™", "×¤×œ×•××‘×• × ×¨×™×”", "×¤× ×§×¨ ×©×™×œ×”", "×¤×¨×©×œ ××œ××›×™", "×§×¦×‘ × ×¢×", "×¨×•×–× ×¦×•×•×™×’ ×‘×¢×– ××©×¨"];
        state.data = names.map(n => ({ name: n, balance: 100, logs: [], weeklyEarned: 0 }));
    }

    function save() { localStorage.setItem('class_bank_v21', JSON.stringify(state)); }

    function updateManual(name, delta) {
        let s = state.data.find(x => x.name === name);
        let pts = delta * 5;
        s.balance += pts;
        s.weeklyEarned += pts;
        s.logs.unshift({ text: "×¢×“×›×•×Ÿ ×™×“× ×™", val: pts });
        render();
    }

    function render() {
        document.getElementById('displayTitle').innerText = state.title;
        document.getElementById('displaySlogan').innerText = state.slogan;
        document.getElementById('minNachat').value = state.prizes.nachat;
        document.getElementById('minChoopar').value = state.prizes.choopar;
        
        const list = document.getElementById('studentList'); list.innerHTML = '';
        const sorted = [...state.data].sort((a,b) => b.balance - a.balance);

        sorted.forEach((s, idx) => {
            // ×—×™×©×•×‘ ×–×›××•×ª ×œ×¤×¨×¡×™×
            let hasDisturbance = s.logs.some(l => l.text.includes("×”×¤×¨×¢×”") || l.val < 0);
            let eligibleNachat = (s.weeklyEarned >= state.prizes.nachat && !hasDisturbance);
            let eligibleChoopar = (s.weeklyEarned >= state.prizes.choopar);

            list.innerHTML += `
                <div class="student-row">
                    <div class="student-header">
                        <div class="controls">
                            <button class="btn-m" style="background:var(--success)" onclick="updateManual('${s.name}', 1)">+</button>
                            <button class="btn-m" style="background:var(--danger); margin-right:5px;" onclick="updateManual('${s.name}', -1)">-</button>
                        </div>
                        <div class="student-info" onclick="toggleHistory('hist-${idx}')">
                            <div class="student-name">
                                ${idx+1}. ${s.name}
                                ${eligibleNachat ? '<span class="prize-badge badge-nachat">ğŸ’Œ × ×—×ª</span>' : ''}
                                ${eligibleChoopar ? '<span class="prize-badge badge-choopar">ğŸ« ×¦\'×•×¤×¨</span>' : ''}
                            </div>
                        </div>
                        <div class="score-box">
                            <span>${s.balance}</span>
                            <span class="weekly-label">${s.weeklyEarned >= 0 ? '+' : ''}${s.weeklyEarned}</span>
                        </div>
                    </div>
                    <div id="hist-${idx}" class="history-panel">
                        ${s.logs.length > 0 ? s.logs.map(l => `<div style="display:flex; justify-content:space-between;"><span>${l.text}</span><span style="color:${l.val>=0?'var(--success)':'var(--danger)'}">${l.val>=0?'+':''}${l.val}</span></div>`).join('') : '××™×Ÿ ×¤×¢×•×œ×•×ª ×©×‘×•×¢×™×•×ª'}
                    </div>
                </div>`;
        });

        const pod = document.getElementById('podium');
        pod.innerHTML = `
            <div style="text-align:center"><small>${sorted[1].name}</small><div style="background:var(--silver); width:50px; height:50px; border-radius:8px; color:black; font-weight:bold; margin:0 auto;">ğŸ¥ˆ</div></div>
            <div style="text-align:center"><small>${sorted[0].name}</small><div style="background:var(--gold); width:60px; height:80px; border-radius:8px; color:black; font-weight:bold; margin:0 auto;">ğŸ¥‡</div></div>
            <div style="text-align:center"><small>${sorted[2].name}</small><div style="background:var(--bronze); width:50px; height:35px; border-radius:8px; color:black; font-weight:bold; margin:0 auto;">ğŸ¥‰</div></div>`;
        
        if(state.photo) { document.getElementById('classPhoto').src = state.photo; document.getElementById('classPhoto').style.display='block'; }
        save();
    }

    function loadExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            json.forEach(row => {
                const rowStr = row.join(" ");
                let s = state.data.find(n => rowStr.includes(n.name));
                if (s) {
                    const rules = { "×—×™×¡×•×¨": -5, "××™×œ×” ×˜×•×‘×”": 10, "×¢×–×¨×”": 15, "×”×©×ª×ª×¤×•×ª": 5, "×”×¤×¨×¢×”": -15 };
                    Object.keys(rules).forEach(key => {
                        if(rowStr.includes(key)) {
                            let val = rules[key];
                            // ×—×•×§ ×—×™×¡×•×¨×™× (××¢×œ 10 ×—×™×¡×•×¨×™× ××•×¨×™×“ 5)
                            if(key === "×—×™×¡×•×¨") {
                                let absences = s.logs.filter(l => l.text.includes("×—×™×¡×•×¨")).length;
                                val = (absences >= 10) ? -5 : 0;
                            }
                            s.balance += val;
                            s.weeklyEarned += val;
                            s.logs.unshift({ text: key, val: val });
                        }
                    });
                }
            });
            render(); alert("× ×ª×•× ×™ ××§×¡×œ ×¢×•×“×›× ×•!");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function toggleAdmin() { const p = document.getElementById('adminPanel'); p.style.display = (p.style.display === 'block') ? 'none' : 'block'; }
    function toggleHistory(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function resetWeek() { if(confirm("×œ××¤×¡ ××ª ×”× ×™×§×•×“ ×”×©×‘×•×¢×™ ×•×”×”×™×¡×˜×•×¨×™×”?")) { state.data.forEach(s => { s.balance=100; s.logs=[]; s.weeklyEarned=0; }); render(); } }
    function updateTexts() { state.title = document.getElementById('inputTitle').value; render(); }
    function uploadPhoto(e) { const r = new FileReader(); r.onload = (f) => { state.photo = f.target.result; render(); }; r.readAsDataURL(e.target.files[0]); }

    render();
</script>
</body>
</html>
