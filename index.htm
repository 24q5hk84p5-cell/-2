<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ × ×™×§×•×“ ×›×™×ª×ª×™×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --success: #22c55e;
            --danger: #ef4444; --warning: #f59e0b; --bg: #f8fafc;
            --card: #ffffff; --text: #1e293b;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        
        /* ×›×¨×˜×™×¡ ×ª×œ××™×“ */
        .student-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .student-card { background: var(--card); padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: 0.2s; }
        .student-info { flex-grow: 1; }
        .student-name { font-weight: bold; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }
        .prize-icons { display: flex; gap: 5px; }
        .badge { font-size: 0.7em; padding: 2px 8px; border-radius: 10px; color: white; }

        /* × ×™×§×•×“ */
        .score-section { display: flex; align-items: center; gap: 15px; }
        .score-val { font-size: 1.5em; font-weight: 800; color: var(--primary); min-width: 50px; text-align: center; }
        .btn-circle { width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 1.2em; display: flex; align-items: center; justify-content: center; }

        /* ×¤×•×“×™×•× */
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin: 30px 0; height: 150px; }
        .podium-place { display: flex; flex-direction: column; align-items: center; width: 100px; }
        .podium-bar { width: 100%; border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* × ×™×”×•×œ */
        .admin-panel { background: #e2e8f0; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: none; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .class-photo { width: 100%; max-height: 300px; object-fit: cover; border-radius: 15px; margin-bottom: 20px; display: none; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="header">
    <h1 id="viewTitle">×‘× ×§ ×”×›×™×ª×”</h1>
    <p id="viewSlogan">×‘×•× ×™× ×”×¦×œ×—×” ×‘×™×—×“</p>
    <button class="btn-main no-print" onclick="toggleAdmin()">âš™ï¸ ××¦×‘ ×¢×¨×™×›×”</button>
</div>

<div class="container">
    <div id="adminArea" class="admin-panel no-print">
        <div class="admin-grid">
            <div style="background: white; padding: 15px; border-radius: 10px;">
                <h3>ğŸ“ ×˜×¢×™× ×ª ××§×¡×œ</h3>
                <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="processExcel(event)">
                <p style="font-size: 0.8em; color: gray;">×”×©××•×ª ×™×–×•×”×• ××•×˜×•××˜×™×ª ×œ×œ× ×§×©×¨ ×œ×¡×“×¨ (××©×¤×—×”/×¤×¨×˜×™).</p>
            </div>
            <div style="background: white; padding: 15px; border-radius: 10px;">
                <h3>ğŸ–¼ï¸ ×¢×™×¦×•×‘ ×›×™×ª×”</h3>
                <input type="text" id="editTitle" placeholder="×©× ×”×›×™×ª×”" oninput="updateMeta()"><br><br>
                <input type="text" id="editSlogan" placeholder="×¡×œ×•×’×Ÿ" oninput="updateMeta()"><br><br>
                <input type="file" accept="image/*" onchange="updatePhoto(event)">
            </div>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn-main" style="background: var(--danger);" onclick="resetScores()">ğŸ”„ ××™×¤×•×¡ × ×™×§×•×“ ×©×‘×•×¢×™</button>
            <button class="btn-main" style="background: var(--warning);" onclick="exportData()">ğŸ’¾ ×’×™×‘×•×™ × ×ª×•× ×™×</button>
        </div>
    </div>

    <img id="displayPhoto" class="class-photo">
    
    <div id="podiumArea" class="podium"></div>

    <div id="studentList" class="student-list"></div>
</div>

<script>
    // × ×ª×•× ×™× ×”×ª×—×œ×ª×™×™×
    let state = JSON.parse(localStorage.getItem('class_v1_core')) || {
        students: [
            "××‘×¨××•×‘×™×¥ ×“× ×™××œ", "××™×•×‘ ××™×ª×Ÿ", "××œ×’×¨×‘×œ×™ ×‘× ×™×” ×¢×•×–", "××œ××• × ×ª× ××œ", "××¨×‘×œ ××œ×™×” ××”×¨×•×Ÿ", 
            "×‘×œ×•×¡×˜×•×¦×§×™ ×”×œ×œ ×™×©×™", "×‘×Ÿ ×¢×˜×¨ × ×ª××™ ×™×•×¡×£", "×‘×Ÿ ×¤×•×¨×ª × ×¢×", "×’×•×¨×“×•×Ÿ ×‘× ×™×”", "×’×œ×™×™×–×¨ ×©×œ×•×", 
            "×“×”×Ÿ ×™×•×¡×£ ×—×™×™×", "×”×™×¨×©× ×‘×¨×’×¨ ×‘×•×¢×–", "×•×•×™×¡××Ÿ ×™×”×•× ×ª×Ÿ", "×•×œ×¨ × ×•×•×” ××”×¨×Ÿ", "×˜×× ×” ××‘×™×”×•", 
            "×™×•×©×¢×™ × ×¢×", "×™×¢×§×‘×™ ×™×”×•×“×”", "×›×”×Ÿ ×œ×™××•×¨", "×›×”×Ÿ × ×™×ª××™", "×× ×¦×•×¨ ×”×¨××œ", 
            "××¨×¡×™×× ×• ××•×¨×™", "× ×“×œ × ×•×”", "× ×™××–×•×‘ ××‘×™××œ", "×¡×× ×™ ×©×‘×—", "×¤×•×¨×¡×˜ ×¢××™×—×™", 
            "×¤×œ×•××‘×• × ×¨×™×”", "×¤× ×§×¨ ×©×™×œ×”", "×¤×¨×©×œ ××œ××›×™", "×§×¦×‘ × ×¢×", "×¨×•×–× ×¦×•×•×™×’ ×‘×¢×– ××©×¨"
        ].map(name => ({ name, score: 100, weeklyLogs: [] })),
        config: { title: "×‘× ×§ ×”×›×™×ª×” ×—/2", slogan: "××œ ×ª×”×™×• ×›×¢×‘×“×™× ×”××©××©×™× ××ª ×”×¨×‘...", photo: "" },
        prizes: [
            { name: "ğŸ’Œ ×”×•×“×¢×ª × ×—×ª", minScore: 125, noBadBehavior: true, minGood: 3 },
            { name: "ğŸ« ×¦'×•×¤×¨ ×©×‘×•×¢×™", minScore: 145, noBadBehavior: false, minGood: 0 }
        ]
    };

    function save() { localStorage.setItem('class_v1_core', JSON.stringify(state)); }

    // ×¤×•× ×§×¦×™×™×ª ×–×™×”×•×™ ×©××•×ª ×’××™×©×”
    function findStudent(rawName) {
        const clean = (s) => s.split(' ').filter(x => x.length > 1).sort().join('');
        const searchName = clean(rawName);
        return state.students.find(s => clean(s.name) === searchName || clean(s.name).includes(searchName) || searchName.includes(clean(s.name)));
    }

    function updateScore(studentName, amount, reason = "×¢×“×›×•×Ÿ ×™×“× ×™") {
        const s = state.students.find(x => x.name === studentName);
        if (s) {
            s.score += amount;
            s.weeklyLogs.push({ reason, amount, date: new Date().toLocaleDateString() });
            render();
        }
    }

    function render() {
        // ×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª
        document.getElementById('viewTitle').innerText = state.config.title;
        document.getElementById('viewSlogan').innerText = state.config.slogan;
        if(state.config.photo) {
            const img = document.getElementById('displayPhoto');
            img.src = state.config.photo; img.style.display = 'block';
        }

        // ×¤×•×“×™×•×
        const sorted = [...state.students].sort((a,b) => b.score - a.score);
        const podArea = document.getElementById('podiumArea');
        podArea.innerHTML = `
            <div class="podium-place"><small>${sorted[1].name}</small><div class="podium-bar" style="height:60px; background:#cbd5e1;">ğŸ¥ˆ</div></div>
            <div class="podium-place"><small>${sorted[0].name}</small><div class="podium-bar" style="height:90px; background:#fbbf24;">ğŸ¥‡</div></div>
            <div class="podium-place"><small>${sorted[2].name}</small><div class="podium-bar" style="height:40px; background:#cd7f32;">ğŸ¥‰</div></div>
        `;

        // ×¨×©×™××”
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        sorted.forEach((s, i) => {
            // ×‘×“×™×§×ª ×–×›××•×ª ×œ×¤×¨×¡×™×
            const badCount = s.weeklyLogs.filter(l => l.amount < 0).length;
            const goodCount = s.weeklyLogs.filter(l => l.amount > 0).length;
            
            let prizeHTML = '';
            state.prizes.forEach(p => {
                const scoreOk = s.score >= p.minScore;
                const behaviorOk = !p.noBadBehavior || (p.noBadBehavior && badCount === 0);
                const goodOk = goodCount >= p.minGood;
                if (scoreOk && behaviorOk && goodOk) {
                    prizeHTML += `<span class="badge" style="background:var(--warning)">${p.name}</span>`;
                }
            });

            list.innerHTML += `
                <div class="student-card">
                    <div class="student-info">
                        <div class="student-name">${i+1}. ${s.name} <div class="prize-icons">${prizeHTML}</div></div>
                    </div>
                    <div class="score-section">
                        <button class="btn-circle" style="background:var(--danger)" onclick="updateScore('${s.name}', -5)">-</button>
                        <div class="score-val">${s.score}</div>
                        <button class="btn-circle" style="background:var(--success)" onclick="updateScore('${s.name}', 5)">+</button>
                    </div>
                </div>
            `;
        });
        save();
    }

    function processExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

            rows.forEach(row => {
                const text = row.join(" ");
                const student = findStudent(text);
                if (student) {
                    // ×—×™×¤×•×© ××™×œ×•×ª ××¤×ª×—
                    if (text.includes("×”×¤×¨×¢×”")) updateScore(student.name, -15, "×”×¤×¨×¢×”");
                    if (text.includes("××™×œ×” ×˜×•×‘×”")) updateScore(student.name, 5, "××™×œ×” ×˜×•×‘×”");
                    if (text.includes("×—×™×¡×•×¨")) updateScore(student.name, -5, "×—×™×¡×•×¨");
                    if (text.includes("×”×©×ª×ª×¤×•×ª")) updateScore(student.name, 5, "×”×©×ª×ª×¤×•×ª");
                }
            });
            alert("×”× ×ª×•× ×™× × ×¡×¨×§×• ×‘×”×¦×œ×—×”!");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function toggleAdmin() {
        const el = document.getElementById('adminArea');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function resetScores() {
        if(confirm("×œ××¤×¡ ××ª ×›×œ ×”× ×™×§×•×“ ×œ-100? (×”×”×™×¡×˜×•×¨×™×” ×”×©×‘×•×¢×™×ª ×ª×™××—×§)")) {
            state.students.forEach(s => { s.score = 100; s.weeklyLogs = []; });
            render();
        }
    }

    function updateMeta() {
        state.config.title = document.getElementById('editTitle').value;
        state.config.slogan = document.getElementById('editSlogan').value;
        render();
    }

    function updatePhoto(e) {
        const r = new FileReader();
        r.onload = (f) => { state.config.photo = f.target.result; render(); };
        r.readAsDataURL(e.target.files[0]);
    }

    render();
</script>
</body>
</html>
