<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>拽 转 - 驻专 拽 </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --success: #22c55e; --danger: #ef4444; --text: #f8fafc;
            --gold: #fbbf24; --silver: #94a3b8; --bronze: #d97706;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; }
        .sticky-header { position: sticky; top: 0; width: 100%; background: rgba(15, 23, 42, 0.95); padding: 15px 0; display: flex; justify-content: center; z-index: 1000; border-bottom: 1px solid #334155; backdrop-filter: blur(10px); }
        
        .class-photo-container { width: 100%; max-width: 850px; margin: 20px 0; text-align: center; }
        #classPhoto { width: 100%; max-height: 250px; object-fit: cover; border-radius: 24px; border: 2px solid var(--accent); display: none; }

        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin: 20px 0; height: 160px; width: 100%; max-width: 500px; }
        .podium-step { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .step-bar { width: 100%; border-radius: 12px 12px 0 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .first { height: 100px; background: var(--gold); order: 2; }
        .second { height: 75px; background: var(--silver); order: 1; }
        .third { height: 55px; background: var(--bronze); order: 3; }
        .podium-name { font-size: 0.8em; margin-bottom: 4px; font-weight: bold; color: white; text-align: center; }
        
        .container { width: 100%; max-width: 850px; background: var(--card-bg); border-radius: 24px; overflow: hidden; border: 1px solid #334155; }
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        
        .student-row { border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; }
        .student-row:hover { background: rgba(255,255,255,0.02); }
        .student-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .score-circle { width: 45px; height: 45px; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid var(--accent); }
        
        /* 驻专 住专 砖驻专 */
        .history-panel { display: none; padding: 15px 25px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); }
        .log-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; padding: 4px 0; border-bottom: 1px dotted rgba(255,255,255,0.1); }
        .pos { color: var(--success); }
        .neg { color: var(--danger); }
        
        .edit-panel { padding: 30px; display: none; }
        .active { display: block; }
        .settings-table { width: 100%; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #334155; }
        input[type="number"] { background: #0f172a; color: white; border: 1px solid var(--accent); border-radius: 6px; padding: 5px; width: 60px; text-align: center; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div style="width:100%; max-width:850px; display:flex; justify-content:space-between; align-items:center; padding:0 20px;">
            <h2 style="margin:0;"> 拽 转</h2>
            <button class="btn" onclick="toggleMode()">锔 </button>
        </div>
    </div>

    <div class="class-photo-container">
        <img id="classPhoto" src="" alt="转 转转转">
    </div>

    <div class="podium-container" id="podium"></div>
    
    <center><button id="restoreBtn" class="btn" style="background:#6366f1; color:white; display:none; margin:10px;" onclick="restoreData()">╋ 砖专 转 砖拽</button></center>

    <div class="container">
        <div id="displaySection" class="active">
            <div style="padding: 10px; text-align: center; color: #94a3b8; font-size: 0.85em;">抓 注 砖 转 爪驻 驻专 拽</div>
            <div id="studentList" style="padding:10px;"></div>
        </div>

        <div id="editSection" class="edit-panel">
            <h3> 驻转 转 转转转</h3>
            <input type="file" accept="image/*" onchange="uploadPhoto(event)" class="btn" style="width:100%; margin-bottom:20px;">
            <hr>
            <h3> 专转 拽</h3>
            <div id="behaviorSettings" class="settings-table"></div>
            <hr>
            <h3> 注转 拽住</h3>
            <input type="file" id="fileIn" accept=".xlsx, .xls" onchange="loadExcel(event)">
            <hr>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" style="background:var(--danger); color:white; width: 100%; padding: 15px;" onclick="resetDataOnly()"> 驻住 拽 住专 砖注</button>
            </div>
        </div>
    </div>

<script>
    const studentNames = ["专抓 ", " 转", "专  注", " 转", "专  专", "住爪拽  砖", " 注专 转 住祝", " 驻专转 注", "专 ", "专 砖", " 住祝 ", "专砖专专 注", "住 转", "专  专", " ", "砖注 注", "注拽 ", " 专", " 转", "爪专 专", "专住 专", " ", " ", "住 砖", "驻专住 注", "驻 专", "驻拽专 砖", "驻专砖 ", "拽爪 注", "专爪 注 砖专"];
    const defaultRules = { "住专 转驻": -5, " ": 10, "注专": 15, "砖转转驻转": 5, "驻专注": -10, "专": -5 };

    let state = JSON.parse(localStorage.getItem('class_bank_v13')) || {
        data: studentNames.map(n => ({ name: n, balance: 100, logs: [] })),
        rules: defaultRules,
        photo: ""
    };

    let backupState = null;

    function save() { localStorage.setItem('class_bank_v13', JSON.stringify(state)); }

    function render() {
        renderPhoto();
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        const sorted = [...state.data].sort((a,b) => b.balance - a.balance);
        
        sorted.forEach((s, idx) => {
            const studentId = `student-${idx}`;
            list.innerHTML += `
                <div class="student-row">
                    <div class="student-header" onclick="toggleHistory('hist-${idx}')">
                        <span>${idx + 1}. ${s.name}</span>
                        <div class="score-circle" style="border-color:${s.balance < 100 ? 'var(--danger)' : 'var(--accent)'}">${s.balance}</div>
                    </div>
                    <div id="hist-${idx}" class="history-panel">
                        <strong>驻专 驻注转:</strong><br><br>
                        ${s.logs.length ? s.logs.map(l => `
                            <div class="log-item">
                                <span>${l.text}</span>
                                <span class="${l.val >= 0 ? 'pos' : 'neg'}">${l.val >= 0 ? '+' : ''}${l.val}</span>
                            </div>
                        `).join('') : '<div style="color:#64748b"> 驻注转 专砖转</div>'}
                    </div>
                </div>`;
        });
        updatePodium(sorted);
        save();
    }

    function updatePodium(sorted) {
        const podiumDiv = document.getElementById('podium');
        podiumDiv.innerHTML = `
            <div class="podium-step"><div class="podium-name">${sorted[1].name}</div><div class="step-bar second"><br>${sorted[1].balance}</div></div>
            <div class="podium-step"><div class="podium-name">${sorted[0].name}</div><div class="step-bar first"><br>${sorted[0].balance}</div></div>
            <div class="podium-step"><div class="podium-name">${sorted[2].name}</div><div class="step-bar third"><br>${sorted[2].balance}</div></div>
        `;
    }

    function toggleHistory(id) {
        const el = document.getElementById(id);
        const allPanels = document.querySelectorAll('.history-panel');
        // 住专转 驻 专  专爪 (驻爪)
        // allPanels.forEach(p => { if(p.id !== id) p.style.display = 'none'; });
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function resetDataOnly() {
        if(confirm("驻住 拽 住专? (转 转砖专)")) {
            backupState = JSON.parse(JSON.stringify(state));
            state.data.forEach(s => { s.balance = 100; s.logs = []; });
            document.getElementById('restoreBtn').style.display = 'inline-block';
            render();
        }
    }

    function restoreData() {
        if(backupState) {
            state = JSON.parse(JSON.stringify(backupState));
            backupState = null;
            document.getElementById('restoreBtn').style.display = 'none';
            render();
        }
    }

    function uploadPhoto(e) {
        const reader = new FileReader();
        reader.onload = (f) => { state.photo = f.target.result; render(); };
        reader.readAsDataURL(e.target.files[0]);
    }

    function renderPhoto() {
        const img = document.getElementById('classPhoto');
        if (state.photo) { img.src = state.photo; img.style.display = 'inline-block'; }
    }

    function loadExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            json.forEach(row => {
                const rowStr = row.join(" ");
                let s = state.data.find(n => rowStr.includes(n.name));
                if (s) {
                    Object.keys(state.rules).forEach(key => {
                        const flexibleKey = key.split(' ').join('\\s+');
                        const regex = new RegExp(`${flexibleKey}(?:\\s*:\\s*(\\d+))?`, 'g');
                        let match;
                        while ((match = regex.exec(rowStr)) !== null) {
                            let count = match[1] ? parseInt(match[1]) : 1;
                            let pts = count * state.rules[key];
                            s.balance += pts;
                            s.logs.unshift({ text: key + (count > 1 ? ` (x${count})` : ''), val: pts });
                        }
                    });
                }
            });
            render(); toggleMode();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function toggleMode() { document.getElementById('editSection').classList.toggle('active'); }
    
    // 爪专转 专转 拽
    const settingsDiv = document.getElementById('behaviorSettings');
    for (let key in state.rules) {
        settingsDiv.innerHTML += `<div class="settings-row"><span>${key}</span><input type="number" value="${state.rules[key]}" onchange="state.rules['${key}']=parseInt(this.value);save()"></div>`;
    }

    render();
</script>
</body>
</html>
