<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title id="pageTitle">拽 转 /2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --success: #22c55e; --danger: #ef4444; --text: #f8fafc;
            --gold: #fbbf24; --silver: #94a3b8; --bronze: #d97706;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; direction: rtl; }
        .sticky-header { position: sticky; top: 0; width: 100%; background: rgba(15, 23, 42, 0.95); padding: 15px 0; display: flex; flex-direction: column; align-items: center; z-index: 1000; border-bottom: 2px solid var(--accent); backdrop-filter: blur(10px); }
        .main-title { font-size: 1.8em; font-weight: 800; color: var(--accent); margin: 0; }
        .slogan { font-size: 0.9em; color: #94a3b8; margin-top: 5px; text-align: center; }
        .container { width: 95%; max-width: 850px; background: var(--card-bg); border-radius: 24px; overflow: hidden; border: 1px solid #334155; margin-top: 20px; }
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .student-row { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 10px; }
        .student-header { display: flex; justify-content: space-between; align-items: center; }
        .controls-manual { display: flex; gap: 10px; margin-left: 15px; }
        .btn-mini { width: 35px; height: 35px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 1.1em; }
        .btn-plus { background: var(--success); }
        .btn-minus { background: var(--danger); }
        .score-circle { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid var(--accent); background: rgba(56, 189, 248, 0.1); }
        .history-panel { display: none; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-top: 10px; }
        .edit-panel { padding: 25px; display: none; }
        textarea, input { background: #0f172a; color: white; border: 1px solid var(--accent); border-radius: 8px; padding: 8px; width: 100%; box-sizing: border-box; }
        .class-photo { width: 100%; max-width: 850px; max-height: 250px; object-fit: cover; border-radius: 20px; margin-top: 20px; display: none; border: 2px solid var(--accent); }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div class="main-title" id="displayTitle">拽 转 /2</div>
        <div class="slogan" id="displaySlogan">" 转 注..."</div>
        <button class="btn" onclick="toggleMode()" style="margin-top: 10px;">锔 </button>
    </div>

    <img id="classPhoto" class="class-photo">
    <div id="podium" style="display:flex; justify-content: center; gap:10px; margin:20px; height: 120px; align-items: flex-end;"></div>
    
    <center><button id="restoreBtn" class="btn" style="background:#6366f1; color:white; display:none; margin-bottom:15px;" onclick="restoreData()">╋ 砖专 驻住</button></center>

    <div class="container">
        <div id="displaySection" class="active">
            <div id="studentList"></div>
        </div>

        <div id="editSection" class="edit-panel">
            <h3> 注专转 转 (驻专 驻住拽)</h3>
            <textarea id="studentNamesInput" rows="5" onchange="updateStudentList()"></textarea>
            
            <h3> 转专转 住</h3>
            <input type="text" id="inputTitle" placeholder="砖 转" oninput="updateTexts()"><br><br>
            <input type="text" id="inputSlogan" placeholder="住" oninput="updateTexts()">
            
            <h3> </h3>
            <button class="btn" onclick="exportData()"> 专 </button>
            <button class="btn" onclick="document.getElementById('importFile').click()"> 注 </button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">

            <hr>
            <h3> 驻住 砖注</h3>
            <button class="btn" style="background:var(--danger); color:white; width:100%" onclick="resetDataOnly()">驻住 拽 (砖专 转 砖转)</button>
        </div>
    </div>

<script>
    let state = JSON.parse(localStorage.getItem('class_bank_v18')) || {
        data: [],
        rules: { "住专": -5, " ": 10, "注专": 15, "砖转转驻转": 5, "驻专注": -15, "专": -5 },
        photo: "", title: "拽 转 /2", slogan: '" 转 注 砖砖 转 专..."'
    };

    if (state.data.length === 0) {
        const names = ["专抓 ", " 转", "专  注", " 转", "专  专", "住爪拽  砖", " 注专 转 住祝", " 驻专转 注", "专 ", "专 砖", " 住祝 ", "专砖专专 注", "住 转", "专  专", " ", "砖注 注", "注拽 ", " 专", " 转", "爪专 专", "专住 专", " ", " ", "住 砖", "驻专住 注", "驻 专", "驻拽专 砖", "驻专砖 ", "拽爪 注", "专爪 注 砖专"];
        state.data = names.map(n => ({ name: n, balance: 100, logs: [] }));
    }

    let backupState = null;

    function save() { localStorage.setItem('class_bank_v18', JSON.stringify(state)); }

    function updateManual(name, delta) {
        let s = state.data.find(x => x.name === name);
        s.balance += (delta * 5); //  爪  5 拽转
        s.logs.unshift({ text: "注 ", val: delta * 5 });
        render();
    }

    function render() {
        document.getElementById('displayTitle').innerText = state.title;
        document.getElementById('displaySlogan').innerText = state.slogan;
        document.getElementById('studentNamesInput').value = state.data.map(s => s.name).join(', ');
        
        const list = document.getElementById('studentList');
        list.innerHTML = '';
        const sorted = [...state.data].sort((a,b) => b.balance - a.balance);
        
        sorted.forEach((s, idx) => {
            list.innerHTML += `
                <div class="student-row">
                    <div class="student-header">
                        <div class="controls-manual">
                            <button class="btn-mini btn-plus" onclick="updateManual('${s.name}', 1)">+</button>
                            <button class="btn-mini btn-minus" onclick="updateManual('${s.name}', -1)">-</button>
                        </div>
                        <div style="flex-grow:1; cursor:pointer; font-weight:bold;" onclick="toggleHistory('hist-${idx}')">
                            ${idx + 1}. ${s.name}
                        </div>
                        <div class="score-circle">${s.balance}</div>
                    </div>
                    <div id="hist-${idx}" class="history-panel">
                        ${s.logs.map(l => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #444;"><span>${l.text}</span><span style="color:${l.val>=0?'var(--success)':'var(--danger)'}">${l.val>=0?'+':''}${l.val}</span></div>`).join('')}
                    </div>
                </div>`;
        });
        
        if(state.photo) { document.getElementById('classPhoto').src = state.photo; document.getElementById('classPhoto').style.display='block'; }
        save();
    }

    function loadExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            json.forEach(row => {
                const rowStr = row.join(" ");
                let s = state.data.find(n => rowStr.includes(n.name));
                if (s) {
                    Object.keys(state.rules).forEach(key => {
                        const regex = new RegExp(`${key}(?:\\s*:\\s*(\\d+))?`, 'g');
                        let match;
                        while ((match = regex.exec(rowStr)) !== null) {
                            let count = match[1] ? parseInt(match[1]) : 1;
                            let pts = 0;
                            
                            if (key === "住专") {
                                // 住驻专转 住专 拽
                                let prevAbsences = s.logs.filter(l => l.text.includes("住专")).length;
                                for(let i=1; i<=count; i++) {
                                    if (prevAbsences + i > 10) pts -= 5;
                                }
                            } else {
                                pts = count * state.rules[key];
                            }
                            
                            if (pts !== 0 || key === "住专") {
                                s.balance += pts;
                                s.logs.unshift({ text: key + (count > 1 ? ` (x${count})` : ''), val: pts });
                            }
                        }
                    });
                }
            });
            render(); alert("注 拽住 砖!");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function updateStudentList() {
        const names = document.getElementById('studentNamesInput').value.split(',').map(n => n.trim()).filter(n => n !== "");
        state.data = names.map(n => {
            let existing = state.data.find(e => e.name === n);
            return existing ? existing : { name: n, balance: 100, logs: [] };
        });
        render();
    }

    function toggleMode() { document.getElementById('editSection').style.display = document.getElementById('editSection').style.display === 'block' ? 'none' : 'block'; }
    function toggleHistory(id) { document.getElementById(id).style.display = document.getElementById(id).style.display === 'block' ? 'none' : 'block'; }
    function updateTexts() { state.title = document.getElementById('inputTitle').value; state.slogan = document.getElementById('inputSlogan').value; render(); }
    function exportData() { const blob = new Blob([JSON.stringify(state)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'bank_backup.json'; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload = (f) => { state = JSON.parse(f.target.result); render(); }; r.readAsText(e.target.files[0]); }
    function resetDataOnly() { backupState = JSON.parse(JSON.stringify(state)); state.data.forEach(s => { s.balance = 100; s.logs = []; }); document.getElementById('restoreBtn').style.display = 'block'; render(); }
    function restoreData() { state = JSON.parse(JSON.stringify(backupState)); backupState = null; document.getElementById('restoreBtn').style.display = 'none'; render(); }

    render();
</script>
</body>
</html>
