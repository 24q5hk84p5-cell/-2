<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××•×¦×¨ ×”×›×™×ª×” - ×’×¨×¡×” 38 ×¡×•×¤×™×ª</title>
    <style>
        :root { --primary: #5d4037; --secondary: #8d6e63; --bg: #e0d7c6; --card: #fffde7; }
        body { background-color: var(--bg); background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; color: #3e2723; }
        .container { max-width: 98%; margin: auto; background: rgba(255, 252, 240, 0.95); padding: 15px; border: 5px double var(--secondary); border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        header { text-align: center; position: relative; margin-bottom: 15px; border-bottom: 2px solid var(--secondary); padding-bottom: 10px; }
        
        .login-box { display: none; background: white; border: 2px solid var(--primary); padding: 15px; border-radius: 8px; position: absolute; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .dashboard { display: grid; grid-template-columns: 1.2fr 1fr 0.9fr 0.9fr 1.1fr; gap: 10px; }
        .section-card { background: var(--card); border: 1px solid var(--secondary); border-radius: 10px; padding: 10px; height: 620px; overflow-y: auto; position: relative; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background: var(--primary); color: white; padding: 8px; position: sticky; top: 0; }
        td { padding: 6px; border-bottom: 1px solid #ddd; text-align: center; }
        
        .btn { cursor: pointer; border: none; font-weight: bold; border-radius: 4px; padding: 6px 12px; transition: 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .teacher-view, .admin-view { display: none; }
        .delete-btn { color: red; cursor: pointer; font-weight: bold; font-size: 1.2em; margin-right: 5px; }
        
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; height: 130px; border-bottom: 3px solid var(--secondary); margin-bottom: 15px; padding-bottom: 5px; }
        .podium-step { width: 60px; border-radius: 8px 8px 0 0; color: white; text-align: center; font-weight: bold; position: relative; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 5px; box-shadow: 0 -3px 6px rgba(0,0,0,0.1); }
        .step-name { color: #3e2723; position: absolute; top: -45px; width: 100%; font-size: 0.75em; font-weight: bold; line-height: 1.2; text-shadow: 1px 1px 0 white; }

        #csvModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border: 4px solid var(--primary); z-index: 2000; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); width: 400px; max-height: 80vh; overflow-y: auto; }
        
        @media print { .no-print { display: none; } body { background: white; } .container { border: none; } .section-card { height: auto; border: 1px solid #ccc; } }
    </style>
</head>
<body>

<div class="container">
    <header class="no-print">
        <button id="topLoginBtn" onclick="toggleBox('topLogin')" style="position: absolute; left: 0; top: 0; padding: 8px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;">ğŸ”‘ × ×™×”×•×œ × ×§×•×“×•×ª</button>
        <div id="topLogin" class="login-box" style="left:0; top:40px;">
            <strong>×¡×™×¡××ª × ×™×”×•×œ:</strong><br>
            <input type="password" id="passTop" style="width:100px; margin:5px 0;" onkeypress="if(event.key==='Enter') checkPass('top')">
            <button onclick="checkPass('top')" class="btn" style="background:green; color:white; width:100%;">×›× ×™×¡×”</button>
        </div>

        <h1>ğŸ›ï¸ ××•×¦×¨ ×”×›×™×ª×”</h1>
        <p id="mainSlogan" style="font-size: 1.2em; font-weight: bold; font-style: italic; color: var(--secondary);"></p>
        
        <div id="photoWrapper" style="display:none; margin:10px auto; max-width:400px;">
            <img id="classPhoto" style="width:100%; border:4px solid var(--primary); border-radius:12px;">
        </div>

        <div class="teacher-view" style="margin:10px 0; background:#f5f5f5; padding:10px; border-radius:10px; display:flex; justify-content:center; gap:10px;">
            <button class="btn" onclick="exportData()" style="background:#2e7d32; color:white;">ğŸ’¾ ×’×™×‘×•×™</button>
            <button class="btn" onclick="document.getElementById('excelLoad').click()" style="background:#ff9800; color:white;">ğŸ“Š ×˜×¢×™× ×ª ××§×¡×œ ×•× ×™×§×•×“ ×§×˜×’×•×¨×™×•×ª</button>
            <button class="btn" onclick="resetWeekly()" style="background:#1565c0; color:white;">ğŸŒ€ ××™×¤×•×¡ ×©×‘×•×¢</button>
            <input type="file" id="excelLoad" style="display:none" accept=".csv" onchange="openCsvManager(event)">
        </div>
    </header>

    <div class="dashboard">
        <div class="section-card no-print">
            <h3>ğŸ“ ×ª×œ××™×“×™×</h3>
            <input type="text" id="search" placeholder="ğŸ” ×—×¤×© ×ª×œ××™×“..." style="width:90%; padding:8px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;" oninput="render()">
            <table>
                <thead><tr><th>×©×</th><th class="teacher-view">+/-</th><th>× ×§×™</th></tr></thead>
                <tbody id="listStudents"></tbody>
            </table>
        </div>

        <div class="section-card">
            <h3>ğŸ† ×¤×•×“×™×•×</h3>
            <div id="podium" class="podium-container"></div>
            <table id="listWeekly"></table>
            <hr>
            <h3>ğŸ… ×¤×¨×¡×™× <button class="admin-view btn" onclick="addItem('prize')" style="background:green; color:white; padding:2px 6px;">+</button></h3>
            <table id="listPrizes"></table>
        </div>

        <div class="section-card no-print">
            <h3>ğŸ’° ×§×•×¤×” ×›×œ×œ×™×ª</h3>
            <table id="listBank"></table>
        </div>

        <div class="section-card" style="background:#f1f8e9;">
            <h3>ğŸ“œ ××—×™×¨×•×Ÿ <button class="admin-view btn" onclick="addItem('shop')" style="background:green; color:white; padding:2px 6px;">+</button></h3>
            <table id="listShop"></table>
        </div>

        <div class="section-card" style="background:#fff3e0;">
            <h3>âš–ï¸ ×ª×§× ×•×Ÿ <button class="admin-view btn" onclick="addItem('rule')" style="background:green; color:white; padding:2px 6px;">+</button></h3>
            <table id="listRules"></table>
        </div>
    </div>

    <div class="no-print" style="margin-top:20px; text-align:center; border-top:1px solid #ccc; padding-top:15px;">
        <button id="botLoginBtn" onclick="toggleBox('botLogin')" class="btn" style="background:#607d8b; color:white;">âš™ï¸ ×¢×¨×™×›×ª ×ª×•×›×Ÿ ×”××¢×¨×›×ª (×ª×§× ×•×Ÿ/×¡×œ×•×’×Ÿ)</button>
        <div id="botLogin" class="login-box" style="bottom:60px; left:50%; transform:translateX(-50%);">
            <strong>×¡×™×¡××ª ×¢×¨×™×›×”:</strong><br>
            <input type="password" id="passBot" style="width:120px; margin:5px 0;" onkeypress="if(event.key==='Enter') checkPass('bot')">
            <button onclick="checkPass('bot')" class="btn" style="background:green; color:white; width:100%;">×›× ×™×¡×” ×œ×¢×¨×™×›×”</button>
        </div>
        
        <div id="adminPanel" class="admin-view" style="background:#cfd8dc; padding:15px; border-radius:10px; margin-top:10px; border:2px solid #546e7a;">
            <strong>ğŸ› ï¸ ××¦×‘ ×¢×¨×™×›×ª ×ª×•×›×Ÿ ×¤×¢×™×œ</strong><br><br>
            ×¡×œ×•×’×Ÿ ×›×™×ª×ª×™: <input type="text" id="setSlogan" style="width:250px" onchange="db.config.slogan=this.value; render()"> |
            ×ª××•× ×ª ×›×™×ª×”: <input type="file" onchange="uploadPhoto(event)"> |
            ×¡×™×¡××ª × ×™×§×•×“: <input type="text" id="newPassTop" style="width:60px" onchange="db.config.passTop=this.value"> |
            <button onclick="fullReset()" class="btn" style="background:red; color:white;">âš ï¸ ××™×¤×•×¡ ×›×œ×œ×™ (×œ-100â‚ª)</button>
        </div>
    </div>
</div>

<div id="csvModal">
    <h3 style="margin-top:0;">ğŸ“Š × ×™×§×•×“ ×§×˜×’×•×¨×™×•×ª ××”×§×•×‘×¥</h3>
    <p style="font-size:0.85em;">×”××¢×¨×›×ª ×–×™×”×ª×” ××ª ×”×§×˜×’×•×¨×™×•×ª ×”×‘××•×ª. ×§×‘×¢ ×›××” ×©×•×•×” ×›×œ ××—×ª:</p>
    <table style="font-size:1em;">
        <thead><tr><th>×§×˜×’×•×¨×™×”</th><th>â‚ª / × ×§'</th><th>âŒ?</th></tr></thead>
        <tbody id="csvScoreBody"></tbody>
    </table>
    <br>
    <button class="btn" onclick="applyCsvData()" style="background:green; color:white; width:100%; padding:10px;">××©×¨ ×•×¢×“×›×Ÿ ××ª ×›×•×œ×</button>
    <button class="btn" onclick="document.getElementById('csvModal').style.display='none'" style="background:#ccc; width:100%; margin-top:5px;">×‘×™×˜×•×œ</button>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('yeshiva_v38')) || {
        config: { slogan: '"××œ ×ª×”×™×• ×›×¢×‘×“×™× ×”××©××©×™× ××ª ×”×¨×‘..."', passTop: "1234", passBot: "4321", photo: "" },
        students: ["××‘×¨××•×‘×™×¥ ×“× ×™××œ", "××™×•×‘ ××™×ª×Ÿ", "××œ×’×¨×‘×œ×™ ×‘× ×™×” ×¢×•×–", "××œ××• × ×ª× ××œ", "××¨×‘×œ ××œ×™×” ××”×¨×•×Ÿ", "×‘×œ×•×¡×˜×•×¦×§×™ ×”×œ×œ ×™×©×™", "×‘×Ÿ ×¢×˜×¨ × ×ª××™ ×™×•×¡×£", "×‘×Ÿ ×¤×•×¨×ª × ×¢×", "×’×•×¨×“×•×Ÿ ×‘× ×™×”", "×’×œ×™×™×–×¨ ×©×œ×•×", "×“×”×Ÿ ×™×•×¡×£ ×—×™×™×", "×”×™×¨×©× ×‘×¨×’×¨ ×‘×•×¢×–", "×•×•×™×¡××Ÿ ×™×”×•× ×ª×Ÿ", "×•×œ×¨ × ×•×•×” ××”×¨×Ÿ", "×˜×× ×” ××‘×™×”×•", "×™×•×©×¢×™ × ×¢×", "×™×¢×§×‘×™ ×™×”×•×“×”", "×›×”×Ÿ ×œ×™××•×¨", "×›×”×Ÿ × ×™×ª××™", "×× ×¦×•×¨ ×”×¨××œ", "××¨×¡×™×× ×• ××•×¨×™", "× ×“×œ × ×•×”", "× ×™××–×•×‘ ××‘×™××œ", "×¡×× ×™ ×©×‘×—", "×¤×•×¨×¡×˜ ×¢××™×—×™", "×¤×œ×•××‘×• × ×¨×™×”", "×¤× ×§×¨ ×©×™×œ×”", "×¤×¨×©×œ ××œ××›×™", "×§×¦×‘ × ×¢×", "×¨×•×–× ×¦×•×•×™×’ ×‘×¢×– ××©×¨"].map(n => ({name:n, total:100, weekly:0, hasNote:false})),
        prizes: [{name:"×”×•×“×¢×ª × ×—×ª", val:45}],
        shop: [{name:"×¤×—×™×ª ×§×•×œ×”", val:50}, {name:"×—×˜×™×£", val:20}],
        rules: [{act: "3 ××™×—×•×¨×™× ×œ×ª×¤×™×œ×”", pun: "1/2 ×©×¢×” ×¢×‘×•×“×”"}, {act: "×—×•×¦×¤×”", pun: "×”×–×× ×ª ×”×•×¨×™×"}]
    };

    let tempCsvData = [];

    function toggleBox(id) { let e = document.getElementById(id); e.style.display = e.style.display === 'block' ? 'none' : 'block'; }
    
    function checkPass(type) {
        let val = type === 'top' ? document.getElementById('passTop').value : document.getElementById('passBot').value;
        let correct = type === 'top' ? db.config.passTop : db.config.passBot;
        if (val === correct || val === "613") {
            document.querySelectorAll(type === 'top' ? '.teacher-view' : '.admin-view').forEach(e => e.style.display = 'inline-block');
            if(type === 'top') document.getElementById('topLoginBtn').style.display = 'none';
            toggleBox(type === 'top' ? 'topLogin' : 'botLogin');
            render();
        } else alert("×¡×™×¡××” ×©×’×•×™×”");
    }

    function openCsvManager(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            let foundCategories = new Set();
            tempCsvData = lines;
            lines.forEach(line => {
                if(line.includes(':')) {
                    line.split(',').forEach(cell => {
                        if(cell.includes(':')) foundCategories.add(cell.split(':')[0].trim());
                    });
                }
            });
            let body = document.getElementById('csvScoreBody');
            body.innerHTML = '';
            foundCategories.forEach(cat => {
                body.innerHTML += `<tr><td>${cat}</td><td><input type="number" class="cat-val" data-cat="${cat}" value="0" style="width:50px"></td><td><input type="checkbox" class="cat-note" data-cat="${cat}"></td></tr>`;
            });
            document.getElementById('csvModal').style.display = 'block';
        };
        reader.readAsText(event.target.files[0]);
    }

    function applyCsvData() {
        let scores = {};
        document.querySelectorAll('.cat-val').forEach(input => {
            let cat = input.dataset.cat;
            scores[cat] = { val: parseInt(input.value), note: document.querySelector(`.cat-note[data-cat="${cat}"]`).checked };
        });
        tempCsvData.forEach((line, i) => {
            if(i === 0) return;
            let name = (line.split(',')[1]||"").trim();
            let student = db.students.find(s => s.name === name);
            if(student) {
                Object.keys(scores).forEach(cat => {
                    if(line.includes(cat)) {
                        student.total += scores[cat].val;
                        student.weekly += scores[cat].val;
                        if(scores[cat].note) student.hasNote = true;
                    }
                });
            }
        });
        document.getElementById('csvModal').style.display = 'none';
        render(); alert("×”××¢×¨×›×ª ×¢×•×“×›× ×” ×œ×¤×™ ×”×§×•×‘×¥!");
    }

    function addItem(type) {
        if(type === 'rule') { let a = prompt("×”× ×”×’×”:"), p = prompt("×ª×•×¦××”:"); if(a) db.rules.push({act:a, pun:p}); }
        if(type === 'shop') { let n = prompt("×©× ×”××•×¦×¨:"), v = prompt("××—×™×¨:"); if(n) db.shop.push({name:n, val:parseInt(v)}); }
        if(type === 'prize') { let n = prompt("×©× ×”×¤×¨×¡:"), v = prompt("× ×§×•×“×•×ª ×“×¨×•×©×•×ª:"); if(n) db.prizes.push({name:n, val:parseInt(v)}); }
        render();
    }

    function deleteItem(type, index) { if(confirm("×œ××—×•×§ ×©×•×¨×” ×–×•?")) { db[type].splice(index, 1); render(); } }

    function render() {
        document.getElementById('mainSlogan').innerText = db.config.slogan;
        if(db.config.photo) { document.getElementById('classPhoto').src = db.config.photo; document.getElementById('photoWrapper').style.display='block'; }
        
        const isEditMode = document.getElementById('adminPanel').style.display === 'block';
        
        // ×¨×©×™××ª ×ª×œ××™×“×™×
        const listS = document.getElementById('listStudents');
        listS.innerHTML = '';
        db.students.forEach((s, i) => {
            if(s.name.includes(document.getElementById('search').value))
                listS.innerHTML += `<tr><td>${s.name}</td><td class="teacher-view"><button onclick="changeS(${i},15)">+</button><button onclick="changeS(${i},-10,true)">-</button></td><td>${s.hasNote?'âŒ':'âœ…'}</td></tr>`;
        });

        // ×§×•×¤×”
        const listB = document.getElementById('listBank');
        listB.innerHTML = '';
        [...db.students].sort((a,b)=>b.total-a.total).forEach(s => listB.innerHTML += `<tr><td>${s.name}</td><td><strong>${s.total}â‚ª</strong></td></tr>`);

        // ×ª×§× ×•×Ÿ
        const listR = document.getElementById('listRules');
        listR.innerHTML = '';
        db.rules.forEach((r, i) => listR.innerHTML += `<tr><td>${isEditMode?`<span class="delete-btn" onclick="deleteItem('rules',${i})">Ã—</span>`:''}${r.act}</td><td style="color:red">${r.pun}</td></tr>`);

        // ××—×™×¨×•×Ÿ
        const listSh = document.getElementById('listShop');
        listSh.innerHTML = '';
        db.shop.forEach((item, i) => listSh.innerHTML += `<tr><td>${isEditMode?`<span class="delete-btn" onclick="deleteItem('shop',${i})">Ã—</span>`:''}${item.name}</td><td>${item.val}â‚ª</td></tr>`);

        // ×¤×•×“×™×•× ×•×–×›××•×ª
        let sw = [...db.students].sort((a,b)=>b.weekly-a.weekly);
        const listW = document.getElementById('listWeekly'), listP = document.getElementById('listPrizes');
        listW.innerHTML = listP.innerHTML = '';
        sw.forEach(s => {
            if(s.weekly !== 0) listW.innerHTML += `<tr><td>${s.name}</td><td>${s.weekly} × ×§'</td></tr>`;
            db.prizes.forEach(p => { if(s.weekly >= p.val && !s.hasNote) listP.innerHTML += `<tr><td>${s.name}</td><td><span style="background:#fbc02d; padding:2px 5px; border-radius:3px;">${p.name}</span></td></tr>`; });
        });

        const pod = document.getElementById('podium');
        pod.innerHTML = '';
        [1,0,2].forEach(p => {
            let s = sw[p];
            if(s && s.weekly > 0) pod.innerHTML += `<div class="podium-step" style="height:${p==1?65:p==0?45:30}px; background:${['#c0c0c0','#ffd700','#cd7f32'][p]}"><div class="step-name">${s.name}</div>${['ğŸ¥ˆ','ğŸ¥‡','ğŸ¥‰'][p]}</div>`;
            else pod.innerHTML += `<div style="width:60px"></div>`;
        });

        localStorage.setItem('yeshiva_v38', JSON.stringify(db));
    }

    function changeS(i,v,n) { db.students[i].total+=v; db.students[i].weekly+=v; if(n) db.students[i].hasNote=true; render(); }
    function resetWeekly() { if(confirm("××™×¤×•×¡ ×©×‘×•×¢? (×”×›×¡×£ ×‘×§×•×¤×” × ×©××¨)")) { db.students.forEach(s=>{s.weekly=0; s.hasNote=false;}); render(); } }
    function fullReset() { if(confirm("âš ï¸ ××™×¤×•×¡ ×›×œ×œ×™! ×›×•×œ× ×—×•×–×¨×™× ×œ-100â‚ª. ×”×× ××ª×” ×‘×˜×•×—?")) { db.students.forEach(s=>{s.total=100; s.weekly=0; s.hasNote=false;}); render(); } }
    function uploadPhoto(e) { const r = new FileReader(); r.onload = ev => { db.config.photo = ev.target.result; render(); }; r.readAsDataURL(e.target.files[0]); }
    function exportData() { const b = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click(); }
    
    render();
</script>
</body>
</html>
