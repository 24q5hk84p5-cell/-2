<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ClassBank Pro - Smart Automation</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --gold: #fbbf24; --silver: #94a3b8; --bronze: #d97706;
            --success: #22c55e; --danger: #ef4444; --text: #f8fafc;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; background: var(--card-bg); border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); }
        .btn-toggle { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 20px; padding: 40px 20px; background: linear-gradient(180deg, rgba(56,189,248,0.1) 0%, transparent 100%); min-height: 250px; }
        .podium-item { display: flex; flex-direction: column; align-items: center; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .rank-bar { width: 100px; border-radius: 15px 15px 5px 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; color: rgba(0,0,0,0.7); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .first .rank-bar { height: 160px; background: var(--gold); }
        .second .rank-bar { height: 120px; background: var(--silver); }
        .third .rank-bar { height: 90px; background: var(--bronze); }

        .student-grid { padding: 20px; display: grid; gap: 12px; }
        .student-card { background: rgba(255,255,255,0.03); border-radius: 16px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .score-circle { background: var(--bg); width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2em; font-weight: 800; border: 3px solid var(--accent); }

        .edit-panel { padding: 30px; display: none; }
        .active { display: block; }
        .history-box { display: none; width: 100%; margin-top: 5px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 12px; font-size: 0.85em; color: #cbd5e1; border: 1px dashed rgba(255,255,255,0.1); }
        
        #classPhoto { max-width: 900px; width: 100%; border-radius: 20px; margin-top: 20px; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid var(--card-bg); }
        
        .rules-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .rule-tag { background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px; font-size: 0.8em; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="header" style="width:100%; max-width:900px; margin-bottom:15px;">
        <h2 id="displayTitle" style="margin:0; color:var(--accent); font-size: 1.8em;">ğŸ¦ ×‘× ×§ ×”×›×™×ª×”</h2>
        <button class="btn-toggle" onclick="toggleMode()">âš™ï¸ × ×™×”×•×œ ××¢×¨×›×ª</button>
    </div>

    <div class="container">
        <div id="displaySection" class="active">
            <div id="podium" class="podium"></div>
            <div id="studentList" class="student-grid"></div>
        </div>

        <div id="editSection" class="edit-panel">
            <h2>âš™ï¸ ×”×’×“×¨×•×ª ×•×—×•×§×™ × ×™×§×•×“</h2>
            <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; margin-bottom:20px;">
                <label>×›×•×ª×¨×ª:</label>
                <input type="text" id="titleInput" style="width:100%; padding:10px; margin:10px 0; background:#0f172a; color:white; border:1px solid #334155; border-radius:8px;" oninput="updateTitle(this.value)">
                
                <h3>××—×™×¨×•×Ÿ ×”×ª× ×”×’×•×ª ××•×˜×•××˜×™:</h3>
                <div id="rulesDisplay" class="rules-list"></div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px;">
                    <h3>×˜×¢×™× ×ª ××§×¡×œ</h3>
                    <p style="font-size:0.8em; color:#94a3b8;">×”×¢×œ×” ×§×•×‘×¥ ×¢× ×©××•×ª ×•×”×ª× ×”×’×•×™×•×ª.</p>
                    <button class="btn-toggle" style="width:100%;" onclick="document.getElementById('fileIn').click()">ğŸ“ ×‘×—×¨ ×§×•×‘×¥ XLSX</button>
                    <input type="file" id="fileIn" style="display:none" onchange="handleExcel(event)">
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px;">
                    <h3>×ª××•× ×” ×•××™×¤×•×¡</h3>
                    <button class="btn-toggle" style="width:100%; margin-bottom:10px;" onclick="document.getElementById('photoIn').click()">ğŸ“· ×”×¢×œ×” ×ª××•× ×”</button>
                    <input type="file" id="photoIn" style="display:none" accept="image/*" onchange="handlePhoto(event)">
                    <button class="btn-toggle" style="background:var(--danger); width:100%;" onclick="resetAll()">ğŸ”„ ××™×¤×•×¡ ××œ×</button>
                </div>
            </div>
        </div>
    </div>

    <img id="classPhoto" src="" alt="×ª××•× ×” ×›×™×ª×ª×™×ª">

<script>
    const defaultNames = ["××‘×¨××•×‘×™×¥ ×“× ×™××œ", "××™×•×‘ ××™×ª×Ÿ", "××œ×’×¨×‘×œ×™ ×‘× ×™×” ×¢×•×–", "××œ××• × ×ª× ××œ", "××¨×‘×œ ××œ×™×” ××”×¨×•×Ÿ", "×‘×œ×•×¡×˜×•×¦×§×™ ×”×œ×œ ×™×©×™", "×‘×Ÿ ×¢×˜×¨ × ×ª××™ ×™×•×¡×£", "×‘×Ÿ ×¤×•×¨×ª × ×¢×", "×’×•×¨×“×•×Ÿ ×‘× ×™×”", "×’×œ×™×™×–×¨ ×©×œ×•×", "×“×”×Ÿ ×™×•×¡×£ ×—×™×™×", "×”×™×¨×©× ×‘×¨×’×¨ ×‘×•×¢×–", "×•×•×™×¡××Ÿ ×™×”×•× ×ª×Ÿ", "×•×œ×¨ × ×•×•×” ××”×¨×Ÿ", "×˜×× ×” ××‘×™×”×•", "×™×•×©×¢×™ × ×¢×", "×™×¢×§×‘×™ ×™×”×•×“×”", "×›×”×Ÿ ×œ×™××•×¨", "×›×”×Ÿ × ×™×ª××™", "×× ×¦×•×¨ ×”×¨××œ", "××¨×¡×™×× ×• ××•×¨×™", "× ×“×œ × ×•×”", "× ×™××–×•×‘ ××‘×™××œ", "×¡×× ×™ ×©×‘×—", "×¤×•×¨×¡×˜ ×¢××™×—×™", "×¤×œ×•××‘×• × ×¨×™×”", "×¤× ×§×¨ ×©×™×œ×”", "×¤×¨×©×œ ××œ××›×™", "×§×¦×‘ × ×¢×", "×¨×•×–× ×¦×•×•×™×’ ×‘×¢×– ××©×¨"];

    // ×—×•×§×™ ×”×”×ª× ×”×’×•×ª - ×”××¢×¨×›×ª ×ª×—×¤×© ××ª ×”××™×œ×™× ×”×œ×œ×• ×‘××§×¡×œ
    const behaviorRules = {
        "××™×œ×” ×˜×•×‘×”": 10,
        "×”×¢×¨×” ×˜×•×‘×”": 10,
        "×¢×–×¨×” ×œ×—×‘×¨": 15,
        "×”×©×ª×ª×¤×•×ª": 5,
        "×”×¤×¨×¢×”": -10,
        "×”×¢×¨×” ×œ× ×˜×•×‘×”": -10,
        "××™ ×”×‘××ª ×¦×™×•×“": -5,
        "×“×™×‘×•×¨": -5,
        "×”×ª× ×”×’×•×ª ×˜×•×‘×”": 10,
        "×•×™×ª×•×¨": 15
    };

    let state = JSON.parse(localStorage.getItem('cb_v9_auto')) || {
        data: defaultNames.map(n => ({ name: n, balance: 100, logs: [] })),
        title: "ğŸ¦ ×‘× ×§ ×”×›×™×ª×”", photo: ""
    };

    function render() {
        document.getElementById('displayTitle').innerText = state.title;
        document.getElementById('titleInput').value = state.title;
        if(state.photo) { document.getElementById('classPhoto').src = state.photo; document.getElementById('classPhoto').style.display = 'block'; }

        // ×”×¦×’×ª ×”×—×•×§×™× ×‘××¦×‘ ×¢×¨×™×›×”
        document.getElementById('rulesDisplay').innerHTML = Object.entries(behaviorRules).map(([name, val]) => `
            <div class="rule-tag"><span>${name}</span><b style="color:${val > 0 ? 'var(--success)' : 'var(--danger)'}">${val > 0 ? '+' : ''}${val}</b></div>
        `).join('');

        // ×¢×“×›×•×Ÿ ×¤×•×“×™×•× ××•×˜×•××˜×™
        const sorted = [...state.data].sort((a,b) => b.balance - a.balance);
        document.getElementById('podium').innerHTML = `
            <div class="podium-item second"><div class="podium-name">${sorted[1].name}</div><div class="rank-bar"><span>${sorted[1].balance}</span></div></div>
            <div class="podium-item first"><div class="podium-name">ğŸ‘‘<br>${sorted[0].name}</div><div class="rank-bar"><span>${sorted[0].balance}</span></div></div>
            <div class="podium-item third"><div class="podium-name">${sorted[2].name}</div><div class="rank-bar"><span>${sorted[2].balance}</span></div></div>
        `;

        const list = document.getElementById('studentList');
        list.innerHTML = '';
        [...state.data].sort((a,b) => a.name.localeCompare(b.name)).forEach((s, i) => {
            const realIdx = state.data.findIndex(x => x.name === s.name);
            list.innerHTML += `
                <div>
                    <div class="student-card">
                        <div style="display:flex; align-items:center; gap:12px; flex:1;">
                            <button onclick="toggleLog(${realIdx})" style="background:none; border:none; cursor:pointer; font-size:1.2em;">ğŸ“‹</button>
                            <span style="font-weight:600;">${s.name}</span>
                        </div>
                        <div class="score-circle" style="border-color:${s.balance < 100 ? 'var(--danger)' : 'var(--success)'}">${s.balance}</div>
                    </div>
                    <div id="log-${realIdx}" class="history-box">
                        <strong>×¤×™×¨×•×˜ × ×™×§×•×“:</strong><br>
                        ${s.logs.length ? s.logs.join('<br>') : '××™×Ÿ ×¢×“×›×•× ×™× ×¨×©×•××™×'}
                    </div>
                </div>
            `;
        });
        localStorage.setItem('cb_v9_auto', JSON.stringify(state));
    }

    // ×¤×•× ×§×¦×™×™×ª ×¢×“×›×•×Ÿ ×—×›××”
    function updateStudent(idx, val, reason) {
        state.data[idx].balance += val;
        const now = new Date();
        const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'})}`;
        state.data[idx].logs.unshift(`${timestamp}: ${val > 0 ? '+' : ''}${val} â‚ª - ${reason}`);
        render();
    }

    // ×§×¨×™××ª ××§×¡×œ ××•×˜×•××˜×™×ª
    function handleExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const workbook = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            
            let successCount = 0;
            rows.forEach(r => {
                const nameInExcel = r[0]?.toString().trim();
                const behaviorInExcel = r[1]?.toString().trim();
                
                const studentIdx = state.data.findIndex(s => s.name === nameInExcel);
                const pointValue = behaviorRules[behaviorInExcel];

                if (studentIdx !== -1 && pointValue !== undefined) {
                    updateStudent(studentIdx, pointValue, behaviorInExcel);
                    successCount++;
                }
            });
            alert(`×”×¤×¢×•×œ×” ×”×•×©×œ××”! ${successCount} ×¢×“×›×•× ×™ ×”×ª× ×”×’×•×ª ×‘×•×¦×¢×• ×•×”×¤×•×“×™×•× ×¢×•×“×›×Ÿ.`);
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function toggleMode() { document.getElementById('displaySection').classList.toggle('active'); document.getElementById('editSection').classList.toggle('active'); }
    function toggleLog(i) { const el = document.getElementById(`log-${i}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    function updateTitle(val) { state.title = val; render(); }
    function handlePhoto(e) { const r = new FileReader(); r.onload = (ev) => { state.photo = ev.target.result; render(); }; r.readAsDataURL(e.target.files[0]); }
    function resetAll() { if(confirm("×œ××¤×¡ ×”×›×œ?")) { state.data.forEach(s => {s.balance=100; s.logs=[];}); render(); } }

    render();
</script>
</body>
</html>
