<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title id="pageTitle">拽 转 /2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --accent: #38bdf8;
            --success: #22c55e; --danger: #ef4444; --text: #f8fafc;
            --gold: #fbbf24; --silver: #94a3b8; --bronze: #d97706;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; }
        
        .sticky-header { position: sticky; top: 0; width: 100%; background: rgba(15, 23, 42, 0.95); padding: 15px 0; display: flex; flex-direction: column; align-items: center; z-index: 1000; border-bottom: 2px solid var(--accent); backdrop-filter: blur(10px); }
        .main-title { font-size: 1.8em; font-weight: 800; color: var(--accent); margin: 0; text-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        .slogan { font-size: 0.95em; color: #94a3b8; font-style: italic; margin-top: 5px; text-align: center; max-width: 90%; }

        .class-photo-container { width: 100%; max-width: 850px; margin: 20px 0; text-align: center; padding: 0 10px; box-sizing: border-box; }
        #classPhoto { width: 100%; max-height: 300px; object-fit: cover; border-radius: 24px; border: 3px solid #334155; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin: 20px 0; height: 160px; width: 100%; max-width: 500px; }
        .podium-step { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .step-bar { width: 100%; border-radius: 12px 12px 0 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; color: #000; }
        .first { height: 100px; background: var(--gold); order: 2; }
        .second { height: 75px; background: var(--silver); order: 1; }
        .third { height: 55px; background: var(--bronze); order: 3; }
        .podium-name { font-size: 0.8em; margin-bottom: 4px; font-weight: bold; color: white; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90px; }
        
        .container { width: 95%; max-width: 850px; background: var(--card-bg); border-radius: 24px; overflow: hidden; border: 1px solid #334155; }
        .btn { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        
        .student-row { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .student-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .score-circle { width: 45px; height: 45px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid var(--accent); }
        
        .history-panel { display: none; padding: 15px 25px; background: rgba(0,0,0,0.4); border-top: 1px solid rgba(255,255,255,0.05); }
        .log-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; border-bottom: 1px dotted rgba(255,255,255,0.1); padding-bottom: 4px; }
        
        .edit-panel { padding: 30px; display: none; }
        .active { display: block; }
        .settings-table { width: 100%; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #334155; }
        input[type="text"], input[type="number"] { background: #0f172a; color: white; border: 1px solid var(--accent); border-radius: 8px; padding: 8px; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div class="main-title" id="displayTitle">拽 转 /2</div>
        <div class="slogan" id="displaySlogan">" 转 注 砖砖 转 专 注 转 拽 驻专住..."</div>
        <div style="width:100%; max-width:850px; display:flex; justify-content:flex-end; padding:10px 20px 0 20px;">
            <button class="btn" onclick="toggleMode()">锔  注专</button>
        </div>
    </div>

    <div class="class-photo-container">
        <img id="classPhoto" src="" alt="转 转转转">
    </div>

    <div class="podium-container" id="podium"></div>
    
    <center><button id="restoreBtn" class="btn" style="background:#6366f1; color:white; display:none; margin:15px;" onclick="restoreData()">╋ 砖专 转 (Undo)</button></center>

    <div class="container">
        <div id="displaySection" class="active">
            <div id="studentList" style="padding:10px;"></div>
        </div>

        <div id="editSection" class="edit-panel">
            <h3> 注专转 转专转</h3>
            <div class="settings-table">
                <div class="settings-row">
                    <span>砖 转:</span>
                    <input type="text" id="inputTitle" oninput="updateTexts()" style="width: 60%;">
                </div>
                <div class="settings-row">
                    <span>住:</span>
                    <input type="text" id="inputSlogan" oninput="updateTexts()" style="width: 60%;">
                </div>
            </div>

            <hr>
            <h3> 转 转转转</h3>
            <input type="file" accept="image/*" onchange="uploadPhoto(event)" class="btn" style="width:100%; margin-bottom:20px;">
            
            <hr>
            <h3> 注专 拽</h3>
            <div id="behaviorSettings" class="settings-table"></div>
            
            <hr>
            <h3>  拽住</h3>
            <input type="file" id="fileIn" accept=".xlsx, .xls" onchange="loadExcel(event)">
            
            <hr>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" style="background:var(--danger); color:white; width: 100%; padding: 15px; justify-content: center;" onclick="resetDataOnly()"> 驻住 砖注 (拽 住专)</button>
            </div>
        </div>
    </div>

<script>
    const studentNames = ["专抓 ", " 转", "专  注", " 转", "专  专", "住爪拽  砖", " 注专 转 住祝", " 驻专转 注", "专 ", "专 砖", " 住祝 ", "专砖专专 注", "住 转", "专  专", " ", "砖注 注", "注拽 ", " 专", " 转", "爪专 专", "专住 专", " ", " ", "住 砖", "驻专住 注", "驻 专", "驻拽专 砖", "驻专砖 ", "拽爪 注", "专爪 注 砖专"];
    const defaultRules = { "住专 转驻": -5, " ": 10, "注专": 15, "砖转转驻转": 5, "驻专注": -10, "专": -5 };

    let state = JSON.parse(localStorage.getItem('class_bank_h2_v16')) || {
        data: studentNames.map(n => ({ name: n, balance: 100, logs: [] })),
        rules: defaultRules,
        photo: "",
        title: "拽 转 /2",
        slogan: '" 转 注 砖砖 转 专 注 转 拽 驻专住..."'
    };

    let backupState = null;

    function save() { localStorage.setItem('class_bank_h2_v16', JSON.stringify(state)); }

    function updateTexts() {
        state.title = document.getElementById('inputTitle').value;
        state.slogan = document.getElementById('inputSlogan').value;
        document.getElementById('displayTitle').innerText = state.title;
        document.getElementById('displaySlogan').innerText = state.slogan;
        document.getElementById('pageTitle').innerText = state.title;
        save();
    }

    function render() {
        document.getElementById('displayTitle').innerText = state.title;
        document.getElementById('displaySlogan').innerText = state.slogan;
        document.getElementById('inputTitle').value = state.title;
        document.getElementById('inputSlogan').value = state.slogan;

        const img = document.getElementById('classPhoto');
        if (state.photo) { img.src = state.photo; img.style.display = 'inline-block'; }

        const list = document.getElementById('studentList');
        list.innerHTML = '';
        const sorted = [...state.data].sort((a,b) => b.balance - a.balance);
        
        sorted.forEach((s, idx) => {
            list.innerHTML += `
                <div class="student-row">
                    <div class="student-header" onclick="toggleHistory('hist-${idx}')">
                        <span style="font-weight:600;">${idx + 1}. ${s.name}</span>
                        <div class="score-circle" style="border-color:${s.balance < 100 ? 'var(--danger)' : 'var(--accent)'}">${s.balance}</div>
                    </div>
                    <div id="hist-${idx}" class="history-panel">
                        ${s.logs.length ? s.logs.map(l => `<div class="log-item"><span>${l.text}</span><span style="color:${l.val>=0?'var(--success)':'var(--danger)'}">${l.val>=0?'+':''}${l.val}</span></div>`).join('') : ' 住专'}
                    </div>
                </div>`;
        });
        updatePodium(sorted);
        save();
    }

    function updatePodium(sorted) {
        const podiumDiv = document.getElementById('podium');
        podiumDiv.innerHTML = `
            <div class="podium-step"><div class="podium-name">${sorted[1].name}</div><div class="step-bar second"><br>${sorted[1].balance}</div></div>
            <div class="podium-step"><div class="podium-name">${sorted[0].name}</div><div class="step-bar first"><br>${sorted[0].balance}</div></div>
            <div class="podium-step"><div class="podium-name">${sorted[2].name}</div><div class="step-bar third"><br>${sorted[2].balance}</div></div>
        `;
    }

    function toggleHistory(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    function uploadPhoto(e) { const reader = new FileReader(); reader.onload = (f) => { state.photo = f.target.result; render(); }; reader.readAsDataURL(e.target.files[0]); }
    function toggleMode() { document.getElementById('editSection').classList.toggle('active'); if(document.getElementById('editSection').classList.contains('active')) window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }
    
    function resetDataOnly() {
        if(confirm("驻住 拽 住专?")) {
            backupState = JSON.parse(JSON.stringify(state));
            state.data.forEach(s => { s.balance = 100; s.logs = []; });
            document.getElementById('restoreBtn').style.display = 'inline-block';
            render();
        }
    }

    function restoreData() {
        if(backupState) { state = JSON.parse(JSON.stringify(backupState)); backupState = null; document.getElementById('restoreBtn').style.display = 'none'; render(); }
    }

    function loadExcel(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
            json.forEach(row => {
                const rowStr = row.join(" ");
                let s = state.data.find(n => rowStr.includes(n.name));
                if (s) {
                    Object.keys(state.rules).sort((a,b)=>b.length-a.length).forEach(key => {
                        const regex = new RegExp(`${key.split(' ').join('\\s+')}(?:\\s*:\\s*(\\d+))?`, 'g');
                        let match;
                        while ((match = regex.exec(rowStr)) !== null) {
                            let count = match[1] ? parseInt(match[1]) : 1;
                            s.balance += (count * state.rules[key]);
                            s.logs.unshift({ text: key + (count > 1 ? ` (x${count})` : ''), val: count * state.rules[key] });
                        }
                    });
                }
            });
            render(); toggleMode();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    const settingsDiv = document.getElementById('behaviorSettings');
    for (let key in state.rules) {
        settingsDiv.innerHTML += `<div class="settings-row"><span>${key}</span><input type="number" value="${state.rules[key]}" onchange="state.rules['${key}']=parseInt(this.value);save()"></div>`;
    }

    render();
</script>
</body>
</html>
